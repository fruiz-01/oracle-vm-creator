name: OCI ARM VM - Auto Retry

on:
  workflow_dispatch:
    inputs:
      max_attempts:
        description: 'N√∫mero m√°ximo de intentos (0 = infinito)'
        required: false
        default: '0'
      wait_seconds:
        description: 'Segundos entre intentos'
        required: false
        default: '15'
  schedule:
    - cron: '0 * * * *'

concurrency:
  group: oci-arm-vm
  cancel-in-progress: true

jobs:
  create-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - name: Setup OCI CLI
        run: |
          pip install oci-cli --quiet

      - name: Configure OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/private_key.pem
          chmod 600 ~/.oci/private_key.pem
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/private_key.pem
          EOF
          chmod 600 ~/.oci/config

      - name: Verificar si la VM ya existe
        run: |
          echo "üîç Verificando si la VM ARM ya existe..."

          EXISTING=$(oci compute instance list \
            --compartment-id ${{ secrets.OCI_TENANCY_OCID }} \
            --display-name "arm-free-tier" \
            --lifecycle-state RUNNING \
            --query 'data[0].id' \
            --raw-output 2>/dev/null || echo "null")

          if [ "$EXISTING" != "null" ] && [ -n "$EXISTING" ]; then
            echo "‚úÖ La VM ARM ya existe y est√° corriendo."
            echo "   ID: $EXISTING"
            echo "   No es necesario crear otra. Workflow finalizado."
            exit 0
          fi

          EXISTING_PROV=$(oci compute instance list \
            --compartment-id ${{ secrets.OCI_TENANCY_OCID }} \
            --display-name "arm-free-tier" \
            --lifecycle-state PROVISIONING \
            --query 'data[0].id' \
            --raw-output 2>/dev/null || echo "null")

          if [ "$EXISTING_PROV" != "null" ] && [ -n "$EXISTING_PROV" ]; then
            echo "‚è≥ La VM ARM ya est√° siendo provisionada (PROVISIONING)."
            echo "   ID: $EXISTING_PROV"
            echo "   Espera unos minutos a que termine. Workflow finalizado."
            exit 0
          fi

          echo "‚úÖ No existe VM previa. Procediendo a crear..."

      - name: Try to create ARM VM (with retries)
        env:
          IMAGE_ID: ${{ secrets.OCI_IMAGE_ID }}
          SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
          SSH_KEY: ${{ secrets.OCI_SSH_KEY }}
          MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts || '0' }}
          WAIT_SECONDS: ${{ github.event.inputs.wait_seconds || '15' }}
        run: |
          attempt=0

          AD=$(oci iam availability-domain list \
            --compartment-id ${{ secrets.OCI_TENANCY_OCID }} \
            --query 'data[0].name' \
            --raw-output)

          echo "Availability Domain: $AD"
          echo "Imagen: $IMAGE_ID"
          echo "Subnet: $SUBNET_ID"
          echo ""

          while true; do
            attempt=$((attempt + 1))
            echo "=========================================="
            echo "üîÑ Intento #$attempt - $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            RESULT=$(oci compute instance launch \
              --availability-domain "$AD" \
              --compartment-id "${{ secrets.OCI_TENANCY_OCID }}" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "$IMAGE_ID" \
              --subnet-id "$SUBNET_ID" \
              --assign-public-ip true \
              --display-name "arm-free-tier" \
              --ssh-authorized-keys-file <(echo "$SSH_KEY") \
              --metadata '{"user_data": ""}' \
              --boot-volume-size-in-gbs 100 \
              2>&1) && SUCCESS=true || SUCCESS=false

            if [ "$SUCCESS" = "true" ]; then
              echo ""
              echo "‚úÖ ¬°VM CREADA EXITOSAMENTE!"
              echo "$RESULT" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          inst = data['data']
          print(f\"  ID:        {inst['id']}\")
          print(f\"  Name:      {inst['display-name']}\")
          print(f\"  State:     {inst['lifecycle-state']}\")
          print(f\"  Shape:     {inst['shape']}\")
          print(f\"  OCPUs:     {inst['shape-config']['ocpus']}\")
          print(f\"  RAM:       {inst['shape-config']['memory-in-gbs']} GB\")
          print(f\"  Region:    {inst['region']}\")
          "
              echo "üéâ La VM ARM gratuita fue creada. Workflow finalizado."
              exit 0
            else
              # Clasificaci√≥n detallada de errores
              if echo "$RESULT" | grep -qi "Out of host capacity"; then
                echo "‚è≥ [SIN CAPACIDAD] No hay hosts ARM disponibles en este momento."

              elif echo "$RESULT" | grep -qi "LimitExceeded"; then
                echo "üö´ [L√çMITE EXCEDIDO] Se alcanz√≥ el l√≠mite de recursos de la cuenta."
                echo "   Detalle: $RESULT"
                exit 1

              elif echo "$RESULT" | grep -qi "NotAuthorizedOrNotFound"; then
                echo "üîê [AUTH ERROR] Problema de permisos o recurso no encontrado."
                echo "   Detalle: $RESULT"
                echo "   Verifica que IMAGE_ID, SUBNET_ID y credenciales sean correctos."
                exit 1

              elif echo "$RESULT" | grep -qi "TooManyRequests"; then
                echo "‚ö†Ô∏è [RATE LIMIT] Demasiadas solicitudes. Esperando 60 segundos..."
                sleep 60
                continue

              elif echo "$RESULT" | grep -qi "InternalError\|500\|ServiceError"; then
                echo "‚ö†Ô∏è [ERROR OCI] Error interno de Oracle. Reintentando..."
                echo "   Detalle: $RESULT"

              else
                echo "‚ùì [ERROR DESCONOCIDO] No se pudo clasificar el error:"
                echo "   $RESULT"
              fi

              if [ "$MAX_ATTEMPTS" -gt "0" ] && [ "$attempt" -ge "$MAX_ATTEMPTS" ]; then
                echo "‚ùå Se alcanz√≥ el m√°ximo de $MAX_ATTEMPTS intentos sin √©xito."
                exit 1
              fi

              sleep $WAIT_SECONDS
            fi
          done
