name: Create OCI VM

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  create-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Install OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh > install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_USER_OCID }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> ~/.oci/config
          echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config
          echo "key_file=~/.oci/private_key.pem" >> ~/.oci/config
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/private_key.pem
          chmod 600 ~/.oci/private_key.pem

      - name: Intentar crear VM
        env:
          SSH_KEY: ${{ secrets.OCI_SSH_KEY }}
          SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
        run: |
          cat > /tmp/vnic.json << EOF
          {"assignPublicIp": true, "subnetId": "$SUBNET_ID"}
          EOF

          cat > /tmp/metadata.json << EOF
          {"ssh_authorized_keys": "$SSH_KEY"}
          EOF

          RESULT=$(oci compute instance launch \
            --availability-domain "XICm:SA-SANTIAGO-1-AD-1" \
            --compartment-id "${{ secrets.OCI_TENANCY_OCID }}" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
            --image-id "${{ secrets.OCI_IMAGE_ID }}" \
            --create-vnic-details file:///tmp/vnic.json \
            --metadata file:///tmp/metadata.json \
            --display-name "mi-vm-arm" \
            2>&1)

          echo "$RESULT"

          if echo "$RESULT" | grep -q "Out of host capacity"; then
            echo "❌ Sin capacidad disponible, se reintentará en 10 minutos..."
            exit 0
          elif echo "$RESULT" | grep -q "PROVISIONING\|\"id\""; then
            echo "✅ ¡VM creada exitosamente!"
            exit 0
          else
            echo "⚠️ Error inesperado"
            echo "$RESULT"
            exit 1
          fi
